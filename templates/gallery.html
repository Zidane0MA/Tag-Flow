{% extends "base.html" %}

{% block title %}Galería{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shorts.css') }}">
{% endblock %}

{% block content %}
<!-- Filtros y búsqueda -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filtros y Búsqueda
                </h5>
            </div>
            <div class="card-body">
                <form id="filter-form" class="row g-3" method="GET">
                    <!-- Búsqueda por texto -->
                    <div class="col-md-3">
                        <label for="search-input" class="form-label">Búsqueda</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" name="search"
                                   placeholder="Buscar en videos, música, personajes..." 
                                   value="{{ request.args.get('search', '') }}">
                            <button type="submit" class="btn btn-outline-secondary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtro por creador -->
                    <div class="col-md-2">
                        <label for="filter-creator" class="form-label">Creador</label>
                        <select class="form-select" id="filter-creator" name="creator" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            {% for creator in creators %}
                            <option value="{{ creator }}" 
                                    {% if request.args.get('creator') == creator %}selected{% endif %}>
                                {{ creator }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Filtro por plataforma -->
                    <div class="col-md-1">
                        <label for="filter-platform" class="form-label">Plataforma</label>
                        <select class="form-select" id="filter-platform" name="platform" onchange="this.form.submit()">
                            <option value="">Todas</option>
                            <option value="tiktok" {% if request.args.get('platform') == 'tiktok' %}selected{% endif %}>TikTok</option>
                            <option value="instagram" {% if request.args.get('platform') == 'instagram' %}selected{% endif %}>Instagram</option>
                            <option value="youtube" {% if request.args.get('platform') == 'youtube' %}selected{% endif %}>YouTube</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por estado de edición -->
                    <div class="col-md-2">
                        <label for="filter-status" class="form-label">Estado de Edición</label>
                        <select class="form-select" id="filter-status" name="status" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="nulo" {% if request.args.get('status') == 'nulo' %}selected{% endif %}>Sin Edición</option>
                            <option value="en_proceso" {% if request.args.get('status') == 'en_proceso' %}selected{% endif %}>En proceso</option>
                            <option value="hecho" {% if request.args.get('status') == 'hecho' %}selected{% endif %}>Completado</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por estado de procesamiento -->
                    <div class="col-md-2">
                        <label for="filter-processing" class="form-label">Estado de Procesamiento</label>
                        <select class="form-select" id="filter-processing" name="processing_status" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="pendiente" {% if request.args.get('processing_status') == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="procesando" {% if request.args.get('processing_status') == 'procesando' %}selected{% endif %}>Procesando</option>
                            <option value="completado" {% if request.args.get('processing_status') == 'completado' %}selected{% endif %}>Completo</option>
                            <option value="error" {% if request.args.get('processing_status') == 'error' %}selected{% endif %}>Error</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por dificultad -->
                    <div class="col-md-1">
                        <label for="filter-difficulty" class="form-label">Dificultad</label>
                        <select class="form-select" id="filter-difficulty" name="difficulty" onchange="this.form.submit()">
                            <option value="">Todas</option>
                            <option value="bajo" {% if request.args.get('difficulty') == 'bajo' %}selected{% endif %}>Bajo</option>
                            <option value="medio" {% if request.args.get('difficulty') == 'medio' %}selected{% endif %}>Medio</option>
                            <option value="alto" {% if request.args.get('difficulty') == 'alto' %}selected{% endif %}>Alto</option>
                        </select>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Filtros activos -->
{% if request.args.get('search') or request.args.get('creator') or request.args.get('platform') or request.args.get('status') or request.args.get('processing_status') or request.args.get('difficulty') or request.args.get('tags') %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <i class="fas fa-filter me-2"></i>
                <strong>Filtros activos:</strong>
                {% if request.args.get('search') %}
                    <span class="badge bg-primary ms-1">Búsqueda: "{{ request.args.get('search') }}"</span>
                {% endif %}
                {% if request.args.get('creator') %}
                    <span class="badge bg-secondary ms-1">Creador: {{ request.args.get('creator') }}</span>
                {% endif %}
                {% if request.args.get('platform') %}
                    <span class="badge bg-info ms-1">Plataforma: {{ request.args.get('platform').title() }}</span>
                {% endif %}
                {% if request.args.get('status') %}
                    <span class="badge bg-warning ms-1">Estado: {{ {'nulo': 'Sin Edición', 'en_proceso': 'En proceso', 'hecho': 'Completado'}.get(request.args.get('status'), request.args.get('status')) }}</span>
                {% endif %}
                {% if request.args.get('processing_status') %}
                    <span class="badge bg-success ms-1">Procesamiento: {{ {'pendiente': 'Pendiente', 'procesando': 'Procesando', 'completado': 'Completo', 'error': 'Error'}.get(request.args.get('processing_status'), request.args.get('processing_status').title()) }}</span>
                {% endif %}
                {% if request.args.get('difficulty') %}
                    <span class="badge bg-danger ms-1">Dificultad: {{ request.args.get('difficulty').title() }}</span>
                {% endif %}
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times me-1"></i>Limpiar
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Panel de Edición Masiva -->
<div class="row mb-3" id="bulk-edit-panel" style="display: none;">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="fas fa-check-square me-2"></i>Edición Masiva
                        </h6>
                        <small id="selection-count">0 videos seleccionados</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light" onclick="clearBulkSelection()">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </button>
                        <button class="btn btn-light text-primary" onclick="openBulkEditModal()">
                            <i class="fas fa-edit me-1"></i>Editar Seleccionados
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-auto">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input me-1" id="select-all-videos" onchange="toggleSelectAll()">
                            Seleccionar todo
                        </label>
                    </div>
                    <div class="col">
                        <div class="btn-group btn-group-sm me-2" role="group">
                            <button class="btn btn-outline-secondary" onclick="bulkSetStatus('nulo')">
                                <i class="fas fa-circle me-1"></i>Sin Edición
                            </button>
                            <button class="btn btn-outline-warning" onclick="bulkSetStatus('en_proceso')">
                                <i class="fas fa-play me-1"></i>En Proceso
                            </button>
                            <button class="btn btn-outline-success" onclick="bulkSetStatus('hecho')">
                                <i class="fas fa-check me-1"></i>Completado
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm me-2" role="group">
                            <button class="btn btn-outline-info" onclick="bulkReanalyzeVideos()">
                                <i class="fas fa-sync me-1"></i>Reanalizar Seleccionados
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-danger" onclick="bulkDeleteVideos()">
                                <i class="fas fa-trash me-1"></i>Eliminar Seleccionados
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center stats-card-hover">
            <div class="card-body">
                <h5 class="card-title">{{ stats.total_videos }}</h5>
                <p class="card-text">Total Videos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stats-card-hover">
            <div class="card-body">
                <h5 class="card-title">{{ stats.with_music }}</h5>
                <p class="card-text">Con Música</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stats-card-hover">
            <div class="card-body">
                <h5 class="card-title">{{ stats.with_characters }}</h5>
                <p class="card-text">Con Personajes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stats-card-hover">
            <div class="card-body">
                <h5 class="card-title">{{ stats.by_status.get('hecho', 0) }}</h5>
                <p class="card-text">Completos</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- Galería de videos -->
<div class="row" id="videos-container" data-total-videos="{{ total_videos }}" data-per-page="{{ per_page }}" data-current-page="{{ page }}">
    {% if videos %}
        {% for video in videos %}
        <div class="col-xl-3 col-lg-4 col-sm-6 mb-4 video-card-wrapper" 
             data-creator="{{ video.creator_name }}" 
             data-platform="{{ video.platform }}" 
             data-status="{{ video.edit_status }}" 
             data-processing-status="{{ video.processing_status or 'pendiente' }}"
             data-difficulty="{{ video.difficulty_level or '' }}"
             data-video-id="{{ video.id }}">
            
            <div class="card video-card h-100">
                <!-- Checkbox de selección -->
                <div class="position-absolute" style="top: 0.5rem; left: 0.5rem; z-index: 10;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input video-select" 
                               value="{{ video.id }}" id="video-select-{{ video.id }}" onchange="updateBulkSelection()">
                        <label class="form-check-label sr-only" for="video-select-{{ video.id }}">Seleccionar video {{ video.id }}</label>
                    </div>
                </div>
                
                <!-- Thumbnail -->
                <div class="card-img-top-container position-relative">
                    {% if video.thumbnail_path %}
                        {% set thumbnail_filename = video.thumbnail_path.split('/')[-1] %}
                        <img src="{{ url_for('serve_thumbnail', filename=thumbnail_filename | urlencode) }}" 
                             class="card-img-top thumbnail-image" 
                             alt="Thumbnail de {{ video.file_name }}"
                             onerror="this.src='/static/img/no-thumbnail.svg'">
                    {% else %}
                        <img src="/static/img/no-thumbnail.svg" 
                             class="card-img-top thumbnail-image" 
                             alt="Sin thumbnail">
                    {% endif %}
                    
                    <!-- Zona clickeable para reproducir -->
                    <div class="thumbnail-click-zone" 
                         onclick="playVideoShorts('{{ video.id }}')"
                         title="Ver en modo Shorts">
                    </div>
                    
                    <!-- Overlay con botones -->
                    <div class="card-overlay">
                        <div class="overlay-buttons">
                            <button class="btn btn-primary btn-sm" 
                                    title="Ver en modo Shorts" 
                                    onclick="playVideoShorts('{{ video.id }}')">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-success btn-sm" 
                                    title="Editar" 
                                    onclick="editVideo('{{ video.id }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" 
                                    title="Reanalizar música y personajes" 
                                    onclick="reanalyzeVideo('{{ video.id }}')">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-info btn-sm" 
                                    title="Abrir carpeta" 
                                    onclick="openVideoFolder('{{ video.id }}')">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" 
                                    title="Eliminar video" 
                                    onclick="deleteVideo('{{ video.id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Badges de estado -->
                    <div class="card-badges">
                        <span class="badge bg-{{ 'success' if video.edit_status == 'hecho' else 'warning' if video.edit_status == 'en_proceso' else 'secondary' }}">
                            {{ {'nulo': 'Sin Edición', 'en_proceso': 'En proceso', 'hecho': 'Completado'}.get(video.edit_status, video.edit_status) }}
                        </span>
                        
                        {% if video.processing_status %}
                        <span class="badge bg-{{ 'success' if video.processing_status == 'completado' else 'danger' if video.processing_status == 'error' else 'info' if video.processing_status == 'procesando' else 'light text-dark' }}">
                            {{ {'pendiente': 'Pendiente', 'procesando': 'Procesando', 'completado': 'Completo', 'error': 'Error'}.get(video.processing_status, video.processing_status) }}
                        </span>
                        {% endif %}
                        
                        {% if video.difficulty_level %}
                        <span class="badge bg-{{ 'danger' if video.difficulty_level == 'alto' else 'warning' if video.difficulty_level == 'medio' else 'success' }}">
                            {{ video.difficulty_level.title() }}
                        </span>
                        {% endif %}
                        
                        <span class="badge bg-info">{{ video.platform.title() }}</span>
                    </div>
                </div>
                
                <!-- Información del video -->
                <div class="card-body">
                    <h6 class="card-title">{{ video.creator_name }}</h6>
                    <p class="card-text small text-muted mb-2" title="{{ video.display_title }}">
                        {{ video.display_title[:70] }}{% if video.display_title|length > 70 %}...{% endif %}
                    </p>
                    
                    <!-- Música -->
                    <div class="mb-2">
                        <i class="fas fa-music text-primary me-1"></i>
                        <small>
                            {% if video.final_music %}
                                <strong>{{ video.final_music }}</strong>
                                {% if video.final_music_artist %} - {{ video.final_music_artist }}{% endif %}
                            {% elif video.detected_music %}
                                {{ video.detected_music }}
                                {% if video.detected_music_artist %} - {{ video.detected_music_artist }}{% endif %}
                                <span class="text-muted">(auto)</span>
                            {% else %}
                                <span class="text-muted">Sin música detectada</span>
                            {% endif %}
                        </small>
                    </div>
                    
                    <!-- Personajes -->
                    <div class="mb-2">
                        <i class="fas fa-user-friends text-success me-1"></i>
                        <small>
                            {% set characters = video.final_characters or video.detected_characters %}
                            {% if characters %}
                                {{ characters[:4] | join(', ') }}
                                {% if characters | length > 4 %}
                                    <span class="text-muted">+{{ characters | length - 4 }} más</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Sin personajes</span>
                            {% endif %}
                        </small>
                    </div>
                    
                    <!-- Metadatos técnicos -->
                    <div class="video-metadata">
                        {% if video.duration_seconds %}
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>{{ "%.1f"|format(video.duration_seconds) }}s
                        </small>
                        {% endif %}
                        
                        {% if video.file_size %}
                        <small class="text-muted ms-2">
                            <i class="fas fa-file me-1"></i>{{ "%.1f"|format(video.file_size / 1024 / 1024) }} MB
                        </small>
                        {% endif %}
                    </div>
                    
                    <!-- Notas -->
                    {% if video.notes %}
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fas fa-sticky-note me-1"></i>{{ video.notes[:50] }}...
                        </small>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Footer con acciones rápidas -->
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {{ video.created_at[:10] if video.created_at else 'Fecha desconocida' }}
                        </small>
                        
                        <!-- Botones de edición rápida de estado -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn  btn-outline-secondary {{ 'active' if video.edit_status == 'nulo' else '' }}"
                                    onclick="quickUpdateStatus('{{ video.id }}', 'nulo')"
                                    title="Marcar como sin edición">
                                <i class="fas fa-circle"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning {{ 'active' if video.edit_status == 'en_proceso' else '' }}"
                                    onclick="quickUpdateStatus('{{ video.id }}', 'en_proceso')"
                                    title="Marcar como en proceso">
                                <i class="fas fa-play"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success {{ 'active' if video.edit_status == 'hecho' else '' }}"
                                    onclick="quickUpdateStatus('{{ video.id }}', 'hecho')"
                                    title="Marcar como completado">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <!-- Estado vacío mejorado -->
        <div class="col-12 text-center py-5">
            {% if request.args.get('search') or request.args.get('creator') or request.args.get('platform') or request.args.get('status') %}
                <!-- No hay resultados de búsqueda -->
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No se encontraron videos</h4>
                <p class="text-muted">
                    No hay videos que coincidan con los filtros aplicados.
                    {% if request.args.get('search') %}
                        <br>Búsqueda: "<strong>{{ request.args.get('search') }}</strong>"
                    {% endif %}
                </p>
                <div class="mt-3">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-times me-1"></i>Limpiar Filtros
                    </a>
                    <button onclick="history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </button>
                </div>
                
                <!-- Consejos de búsqueda -->
                <div class="card mt-4 mx-auto" style="max-width: 600px;">
                    <div class="card-body text-start">
                        <h6 class="card-title"><i class="fas fa-lightbulb text-warning me-2"></i>Consejos de búsqueda</h6>
                        <ul class="card-text small mb-0">
                            <li>Busca por <strong>nombre del creador</strong>: "free", "mimizu"</li>
                            <li>Busca por <strong>música</strong>: "gangnam style", "industry baby"</li>
                            <li>Busca por <strong>personajes</strong>: "miku", "kirby", "mario"</li>
                            <li>Busca por <strong>notas</strong>: cualquier texto que hayas agregado</li>
                            <li>Combina filtros usando los desplegables de arriba</li>
                        </ul>
                    </div>
                </div>
            {% else %}
                <!-- Base de datos vacía -->
                <i class="fas fa-video fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No hay videos en la base de datos</h4>
                <p class="text-muted">Ejecuta el script de procesamiento para analizar videos nuevos.</p>
                <div class="mt-3">
                    <code class="bg-light p-2 rounded">python main.py</code>
                </div>
                <p class="text-muted mt-2 small">
                    O usa: <code>python maintenance.py populate-db</code> para importar desde fuentes externas
                </p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Paginación mejorada -->
{% if total_videos > per_page %}
<nav aria-label="Paginación de videos" class="mt-4" id="pagination-controls">
    <div class="row align-items-center">
        <div class="col-md-6">
            <p class="text-muted mb-0">
                Mostrando {{ ((page - 1) * per_page) + 1 }} - {{ [total_videos, page * per_page] | min }} 
                de {{ total_videos }} videos
                {% if request.args.get('search') or request.args.get('creator') or request.args.get('platform') or request.args.get('status') %}
                    (filtrados)
                {% endif %}
            </p>
        </div>
        <div class="col-md-6">
            <ul class="pagination justify-content-end mb-0 flex-wrap">
                <!-- Primera página -->
                {% if page > 2 %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                {% endif %}
                
                <!-- Página anterior -->
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    {% if page > 1 %}
                    <a class="page-link" href="?page={{ page - 1 }}&{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        <i class="fas fa-angle-left"></i> Anterior
                    </a>
                    {% else %}
                    <span class="page-link">
                        <i class="fas fa-angle-left"></i> Anterior
                    </span>
                    {% endif %}
                </li>
                
                <!-- Páginas numéricas -->
                {% set start_page = [1, page - 2] | max %}
                {% set end_page = [total_pages, page + 2] | min %}
                
                {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    {% if p == page %}
                    <span class="page-link">{{ p }}</span>
                    {% else %}
                    <a class="page-link" href="?page={{ p }}&{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        {{ p }}
                    </a>
                    {% endif %}
                </li>
                {% endfor %}
                
                <!-- Página siguiente -->
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    {% if page < total_pages %}
                    <a class="page-link" href="?page={{ page + 1 }}&{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        Siguiente <i class="fas fa-angle-right"></i>
                    </a>
                    {% else %}
                    <span class="page-link">
                        Siguiente <i class="fas fa-angle-right"></i>
                    </span>
                    {% endif %}
                </li>
                
                <!-- Última página -->
                {% if page < total_pages - 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ total_pages }}&{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
{% endif %}

<!-- Indicador de carga para scroll infinito -->
<div id="infinite-loading" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando más videos...</span>
    </div>
    <p class="mt-2 text-muted">Cargando más videos...</p>
</div>

<!-- Mensaje de fin para scroll infinito -->
<div id="infinite-end" class="text-center py-4" style="display: none;">
    <p class="text-muted mb-0">
        <i class="fas fa-check-circle text-success me-2"></i>
        Has visto todos los videos disponibles
    </p>
</div>

<!-- Modal de reproducción tipo TikTok/Shorts -->
<div class="modal fade" id="videoShortsModal" tabindex="-1" aria-labelledby="videoShortsModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-black">
            <!-- Header con controles -->
            <div class="shorts-header">
                <button type="button" class="btn btn-link text-white" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times fs-4"></i>
                </button>
                <div class="header-info text-white">
                    <span id="current-video-position">1</span> / <span id="total-videos-count">{{ total_videos or videos|length }}</span>
                </div>
            </div>

            <!-- Contenedor principal de videos -->
            <div class="shorts-container" id="shorts-container">
                <!-- Los videos se cargarán dinámicamente aquí -->
            </div>

            <!-- Overlay de información del video -->
            <div class="video-overlay" id="video-overlay">
                <!-- Información del lado izquierdo/inferior -->
                <div class="overlay-info">
                    <div class="creator-info" id="current-creator-info">
                        <div class="creator-name">@creador</div>
                        <div class="video-title">Título del video</div>
                    </div>
                    
                    <div class="music-info" id="current-music-info">
                        <i class="fas fa-music"></i>
                        <span class="music-text">Música original</span>
                    </div>
                    
                    <div class="video-tags" id="current-video-tags">
                        <!-- Tags/personajes dinámicos -->
                    </div>
                    
                    <div class="video-metadata" id="current-video-metadata">
                        <span class="metadata-item"><i class="fas fa-clock"></i> <span id="video-duration">0:00</span></span>
                        <span class="metadata-item"><i class="fas fa-eye"></i> <span id="video-platform">TikTok</span></span>
                        <span class="metadata-item"><i class="fas fa-calendar"></i> <span id="video-date">Fecha</span></span>
                    </div>
                </div>

                <!-- Información del lado derecho -->
                <div class="overlay-right">
                    <div class="overlay-actions">
                        <button class="action-btn" onclick="toggleVideoLike()" title="Me gusta">
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="action-btn" onclick="editCurrentVideo()" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="shareCurrentVideo()" title="Compartir">
                            <i class="fas fa-share"></i>
                        </button>
                        <button class="action-btn" onclick="openCurrentVideoFolder()" title="Abrir carpeta">
                            <i class="fas fa-folder-open"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navegación -->
            <div class="shorts-navigation">
                <button class="nav-btn nav-prev" onclick="previousVideo()" title="Video anterior (↑)">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <button class="nav-btn nav-next" onclick="nextVideo()" title="Siguiente video (↓)">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <!-- Indicador de carga -->
            <div class="shorts-loading" id="shorts-loading" style="display: none;">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Cargando video...</span>
                </div>
            </div>

            <!-- Instrucciones de uso -->
            <div class="shorts-instructions" id="shorts-instructions">
                <div class="instruction-text">
                    <i class="fas fa-arrow-up"></i> / <i class="fas fa-arrow-down"></i> / <i class="fas fa-mouse"></i> Navegar videos
                    <br>
                    <i class="fas fa-space-bar"></i> Pausar/Reproducir
                    <br>
                    <i class="fas fa-times"></i> ESC para salir
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de reproducción tradicional (mantener para compatibilidad) -->
<div class="modal fade" id="videoPlayerModal" tabindex="-1" aria-labelledby="videoPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoPlayerModalLabel">
                    <i class="fas fa-play me-2"></i>Reproductor de Video
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <video id="video-player" class="w-100" controls preload="metadata">
                    <source id="video-source" src="" type="video/mp4">
                    Tu navegador no soporta reproducción de video.
                </video>
                <div id="video-info" class="mt-3 text-muted">
                    <small>Información del video aparecerá aquí</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="openVideoInSystem()">
                    <i class="fas fa-external-link-alt me-1"></i>Abrir en Reproductor del Sistema
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de edición de video -->
<div class="modal fade" id="editVideoModal" tabindex="-1" aria-labelledby="editVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVideoModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Video
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-video-form">
                    <input type="hidden" id="edit-video-id" name="video_id">
                    
                    <div class="row">
                        <!-- Información básica -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Información Básica</h6>
                            
                            <div class="mb-3">
                                <label for="edit-creator-name" class="form-label">Creador</label>
                                <input type="text" class="form-control" id="edit-creator-name" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-file-name" class="form-label">Archivo</label>
                                <input type="text" class="form-control" id="edit-file-name" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-platform" class="form-label">Plataforma</label>
                                <input type="text" class="form-control" id="edit-platform" readonly>
                            </div>
                        </div>
                        
                        <!-- Edición manual -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Edición Manual</h6>
                            
                            <div class="mb-3">
                                <label for="edit-final-music" class="form-label">Música</label>
                                <input type="text" class="form-control" id="edit-final-music" name="final_music" 
                                       placeholder="Nombre de la canción">
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-final-music-artist" class="form-label">Artista</label>
                                <input type="text" class="form-control" id="edit-final-music-artist" name="final_music_artist" 
                                       placeholder="Nombre del artista">
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-difficulty-level" class="form-label">Nivel de Dificultad</label>
                                <select class="form-select" id="edit-difficulty-level" name="difficulty_level">
                                    <option value="">Sin especificar</option>
                                    <option value="bajo">Bajo</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personajes -->
                    <div class="mb-3">
                        <label for="edit-final-characters" class="form-label">Personajes</label>
                        <textarea class="form-control" id="edit-final-characters" name="final_characters" rows="2"
                                  placeholder="Lista de personajes separados por comas"></textarea>
                        <div class="form-text">Separa múltiples personajes con comas</div>
                    </div>
                    
                    <!-- Estado de edición -->
                    <div class="mb-3">
                        <label for="edit-status" class="form-label">Estado de Edición</label>
                        <select class="form-select" id="edit-status" name="edit_status">
                            <option value="nulo">Sin Edición</option>
                            <option value="en_proceso">En proceso</option>
                            <option value="hecho">Completado</option>
                        </select>
                    </div>
                    
                    <!-- Notas -->
                    <div class="mb-3">
                        <label for="edit-notes" class="form-label">Notas</label>
                        <textarea class="form-control" id="edit-notes" name="notes" rows="3"
                                  placeholder="Notas adicionales sobre el video"></textarea>
                    </div>
                    
                    <!-- Información detectada automáticamente (solo lectura) -->
                    <div class="accordion" id="detectedInfoAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDetected">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapseDetected" aria-expanded="false" aria-controls="collapseDetected">
                                    <i class="fas fa-robot me-2"></i>Información Detectada Automáticamente
                                </button>
                            </h2>
                            <div id="collapseDetected" class="accordion-collapse collapse" aria-labelledby="headingDetected" 
                                 data-bs-parent="#detectedInfoAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Música Detectada:</strong>
                                            <p id="detected-music-info" class="mb-2">-</p>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Personajes Detectados:</strong>
                                            <p id="detected-characters-info" class="mb-2">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveVideoChanges()">
                    <i class="fas fa-save me-1"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de edición masiva -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEditModalLabel">
                    <i class="fas fa-edit me-2"></i>Edición Masiva
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong id="bulk-video-count">0</strong> videos seleccionados para edición masiva.
                    Los campos vacíos no se modificarán.
                </div>
                
                <form id="bulk-edit-form">
                    <div class="row">
                        <!-- Estado de edición -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulk-edit-status" class="form-label">Estado de Edición</label>
                                <select class="form-select" id="bulk-edit-status" name="edit_status">
                                    <option value="">No modificar</option>
                                    <option value="nulo">Sin Edición</option>
                                    <option value="en_proceso">En proceso</option>
                                    <option value="hecho">Completado</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Nivel de dificultad -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulk-difficulty-level" class="form-label">Nivel de Dificultad</label>
                                <select class="form-select" id="bulk-difficulty-level" name="difficulty_level">
                                    <option value="">No modificar</option>
                                    <option value="bajo">Bajo</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Música -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulk-final-music" class="form-label">Música</label>
                                <input type="text" class="form-control" id="bulk-final-music" name="final_music" 
                                       placeholder="Dejar vacío para no modificar">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="bulk-clear-music">
                                    <label class="form-check-label" for="bulk-clear-music">
                                        Limpiar música existente
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Artista -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulk-final-music-artist" class="form-label">Artista</label>
                                <input type="text" class="form-control" id="bulk-final-music-artist" name="final_music_artist" 
                                       placeholder="Dejar vacío para no modificar">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="bulk-clear-artist">
                                    <label class="form-check-label" for="bulk-clear-artist">
                                        Limpiar artista existente
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Personajes -->
                    <div class="mb-3">
                        <label for="bulk-final-characters" class="form-label">Personajes</label>
                        <textarea class="form-control" id="bulk-final-characters" name="final_characters" rows="2"
                                  placeholder="Lista de personajes separados por comas (dejar vacío para no modificar)"></textarea>
                        <div class="form-text">Separa múltiples personajes con comas</div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="bulk-clear-characters">
                            <label class="form-check-label" for="bulk-clear-characters">
                                Limpiar personajes existentes
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notas -->
                    <div class="mb-3">
                        <label for="bulk-notes" class="form-label">Notas</label>
                        <textarea class="form-control" id="bulk-notes" name="notes" rows="3"
                                  placeholder="Notas adicionales (dejar vacío para no modificar)"></textarea>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="bulk-clear-notes">
                            <label class="form-check-label" for="bulk-clear-notes">
                                Limpiar notas existentes
                            </label>
                        </div>
                    </div>
                    
                    <!-- Opciones avanzadas -->
                    <div class="accordion" id="bulkAdvancedOptions">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingBulkAdvanced">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapseBulkAdvanced" aria-expanded="false" aria-controls="collapseBulkAdvanced">
                                    <i class="fas fa-cogs me-2"></i>Opciones Avanzadas
                                </button>
                            </h2>
                            <div id="collapseBulkAdvanced" class="accordion-collapse collapse" aria-labelledby="headingBulkAdvanced" 
                                 data-bs-parent="#bulkAdvancedOptions">
                                <div class="accordion-body">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Cuidado:</strong> Estas acciones afectarán todos los videos seleccionados.
                                    </div>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bulk-reprocess">
                                        <label class="form-check-label" for="bulk-reprocess">
                                            <strong>Reprocesar automáticamente</strong> - Ejecutar detección de música y personajes
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bulk-regenerate-thumbnails">
                                        <label class="form-check-label" for="bulk-regenerate-thumbnails">
                                            <strong>Regenerar thumbnails</strong> - Crear nuevas miniaturas
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="previewBulkChanges()">
                    <i class="fas fa-eye me-1"></i>Vista Previa
                </button>
                <button type="button" class="btn btn-primary" onclick="applyBulkChanges()">
                    <i class="fas fa-save me-1"></i>Aplicar Cambios
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">Tag-Flow</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            <!-- Mensaje dinámico -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gallery.js') }}?v={{ (range(1)|random) }}"></script>
<script src="{{ url_for('static', filename='js/shorts.js') }}"></script>
{% endblock %}